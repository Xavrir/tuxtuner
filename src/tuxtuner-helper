#!/bin/bash

# TUXTUNER HELPER
# Handles privileged operations for CPU/GPU control
# Usage: tuxtuner-helper <command> [args...]
#
# SECURITY: This script runs as root via pkexec.
# All inputs MUST be validated before use.

set -euo pipefail
shopt -s nullglob

# Valid GPU modes (allowlist)
readonly VALID_GPU_MODES="Integrated Hybrid Dedicated Compute VFIO"

# Maximum sane CPU count
readonly MAX_CPUS=1024

die() {
    echo "ERROR: $*" >&2
    exit 1
}

validate_numeric() {
    local value="$1"
    local name="${2:-value}"
    
    [[ -n "$value" ]] || die "Missing $name"
    [[ "$value" =~ ^[0-9]+$ ]] || die "Invalid $name: must be numeric"
}

validate_gpu_mode() {
    local mode="$1"
    
    [[ -n "$mode" ]] || die "Missing GPU mode"
    
    # Check against allowlist
    local valid_mode
    for valid_mode in $VALID_GPU_MODES; do
        if [[ "$mode" == "$valid_mode" ]]; then
            return 0
        fi
    done
    
    die "Invalid GPU mode: $mode. Valid modes: $VALID_GPU_MODES"
}

validate_session_id() {
    local session_id="$1"
    
    # Session ID must be numeric only
    [[ "$session_id" =~ ^[0-9]+$ ]] || die "Invalid session ID: must be numeric"
}

COMMAND="${1:-}"
[[ -n "$COMMAND" ]] || die "Missing command"
shift

case "$COMMAND" in
    cpu)
        # Usage: cpu <target_threads>
        # Example: cpu 8
        TARGET="${1:-}"
        validate_numeric "$TARGET" "target thread count"
        
        # Ensure at least 1 CPU stays online
        if [[ "$TARGET" -lt 1 ]]; then
            die "Must keep at least 1 CPU online"
        fi
        
        # Cap at maximum sane value
        if [[ "$TARGET" -gt "$MAX_CPUS" ]]; then
            die "Target exceeds maximum ($MAX_CPUS)"
        fi

        # Count actual CPUs for validation
        actual_cpus=0
        for cpu_dir in /sys/devices/system/cpu/cpu[0-9]*; do
            ((actual_cpus++)) || true
        done
        
        if [[ "$actual_cpus" -eq 0 ]]; then
            die "No CPUs found in sysfs"
        fi
        
        # We assume cpu0 is always online. 
        # We start controlling from cpu1 up to cpuN.
        for cpu_dir in /sys/devices/system/cpu/cpu[0-9]*; do
            cpu_name=$(basename "$cpu_dir")
            cpu_num="${cpu_name#cpu}"
            online_file="$cpu_dir/online"
            
            # Skip cpu0 (always online) or if online file doesn't exist
            if [[ "$cpu_num" == "0" ]] || [[ ! -f "$online_file" ]]; then
                continue
            fi
            
            # Validate cpu_num is actually numeric (defense in depth)
            if ! [[ "$cpu_num" =~ ^[0-9]+$ ]]; then
                continue
            fi
            
            # Logic: If cpu index is less than target, it should be ONLINE (1).
            # TARGET 4 means 4 threads total (0, 1, 2, 3).
            # So if cpu_num (e.g. 3) < TARGET (4), it is ON.
            # If cpu_num (e.g. 4) >= TARGET (4), it is OFF.
            
            if [[ "$cpu_num" -lt "$TARGET" ]]; then
                echo "1" > "$online_file" 2>/dev/null || true
            else
                echo "0" > "$online_file" 2>/dev/null || true
            fi
        done
        
        echo "CPU thread limit set to $TARGET"
        ;;
        
    gpu)
        # Usage: gpu <mode> [--logout <session_id>]
        MODE="${1:-}"
        validate_gpu_mode "$MODE"
        shift
        
        # Set the mode via supergfxctl
        if ! command -v supergfxctl &>/dev/null; then
            die "supergfxctl not found"
        fi
        
        supergfxctl -m "$MODE"
        
        # Check for logout flag
        if [[ "${1:-}" == "--logout" ]]; then
            SESSION_ID="${2:-}"
            if [[ -n "$SESSION_ID" ]]; then
                validate_session_id "$SESSION_ID"
                
                # Schedule logout asynchronously with unique unit name
                # Use -- to prevent argument injection
                systemd-run --unit="tuxtuner-logout-$$-$(date +%s)" --on-active=2s -- \
                    loginctl terminate-session "$SESSION_ID"
            fi
        fi
        
        echo "GPU mode set to $MODE"
        ;;
        
    *)
        die "Unknown command: $COMMAND"
        ;;
esac
